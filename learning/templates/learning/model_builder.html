{% extends 'base.html' %}

{% block title %}Model Builder - {{ lesson.title }}{% endblock %}

{% block extra_css %}
<style>
    /* Glassmorphic Breadcrumb */
    .breadcrumb {
        background: var(--glass-bg);
        backdrop-filter: blur(20px);
        -webkit-backdrop-filter: blur(20px);
        padding: 0.6rem 1rem;
        border-radius: var(--radius-lg);
        box-shadow: var(--shadow-sm);
        margin-bottom: 1.5rem;
        border: 1px solid var(--glass-border);
    }

    .breadcrumb-item a {
        color: var(--color-bright-cyan);
        text-decoration: none;
        transition: all var(--transition-base);
    }

    .breadcrumb-item a:hover {
        color: var(--color-cyber-cyan);
        text-shadow: 0 0 10px rgba(0, 245, 255, 0.5);
    }

    .breadcrumb-item.active {
        color: var(--color-text-secondary);
    }

    /* Modern Cards */
    .card {
        background: var(--glass-bg);
        backdrop-filter: blur(20px);
        -webkit-backdrop-filter: blur(20px);
        border: 1px solid var(--glass-border);
        border-radius: var(--radius-xl);
        box-shadow: var(--shadow-md);
        transition: all var(--transition-base);
        color: var(--color-text-primary);
    }

    .card:hover {
        box-shadow: var(--shadow-lg), 0 0 30px rgba(0, 102, 255, 0.2);
        border-color: rgba(0, 212, 255, 0.3);
    }

    .card-body {
        padding: 1.5rem;
    }

    .card-header {
        background: rgba(45, 59, 84, 0.4);
        border-bottom: 1px solid var(--glass-border);
        padding: 1rem 1.5rem;
        border-radius: var(--radius-xl) var(--radius-xl) 0 0;
        color: var(--color-text-primary);
        font-weight: 600;
    }

    .card-header.bg-primary {
        background: var(--gradient-primary);
        color: white;
        border: none;
    }

    .card-header.bg-dark {
        background: rgba(10, 14, 39, 0.9);
        color: var(--color-text-primary);
        border: none;
    }

    .card-header.bg-success {
        background: var(--gradient-success);
        color: white;
        border: none;
    }

    .card-footer {
        background: rgba(10, 14, 39, 0.5);
        border-top: 1px solid var(--glass-border);
        padding: 0.75rem 1.5rem;
        border-radius: 0 0 var(--radius-xl) var(--radius-xl);
        color: var(--color-text-secondary);
    }

    .card h2 {
        color: var(--color-text-primary);
        font-size: 1.5rem;
        margin-bottom: 0.5rem;
    }

    .text-muted {
        color: var(--color-text-secondary) !important;
    }

    /* Modern Buttons */
    .btn {
        border-radius: var(--radius-lg);
        font-weight: 600;
        transition: all var(--transition-base);
        border: none;
        padding: 0.6rem 1.25rem;
    }

    .btn-primary {
        background: var(--gradient-primary);
        color: white;
        box-shadow: var(--shadow-md);
    }

    .btn-primary:hover {
        transform: translateY(-2px);
        box-shadow: var(--shadow-lg), 0 0 30px rgba(0, 102, 255, 0.4);
    }

    .btn-success {
        background: var(--gradient-success);
        color: white;
        box-shadow: var(--shadow-md);
    }

    .btn-success:hover {
        transform: translateY(-2px);
        box-shadow: var(--shadow-lg), 0 0 30px rgba(0, 245, 160, 0.4);
    }

    .btn-warning {
        background: rgba(255, 176, 32, 0.2);
        color: var(--color-warning);
        border: 1px solid rgba(255, 176, 32, 0.3);
        box-shadow: var(--shadow-sm);
    }

    .btn-warning:hover {
        background: rgba(255, 176, 32, 0.3);
        box-shadow: 0 0 20px rgba(255, 176, 32, 0.4);
    }

    .btn-outline-primary {
        background: transparent;
        color: var(--color-bright-cyan);
        border: 2px solid var(--color-bright-cyan);
    }

    .btn-outline-primary:hover {
        background: var(--gradient-primary);
        color: white;
        box-shadow: var(--shadow-neon);
    }

    .btn-sm {
        padding: 0.4rem 0.85rem;
        font-size: 0.875rem;
    }

    .btn-light {
        background: var(--glass-bg-light);
        color: var(--color-text-primary);
        border: 1px solid var(--glass-border);
    }

    .btn-light:hover {
        background: var(--glass-bg);
        box-shadow: var(--shadow-neon);
    }

    /* List Groups */
    .list-group-item {
        background: rgba(45, 59, 84, 0.4);
        border: 1px solid var(--glass-border);
        color: var(--color-text-secondary);
        transition: all var(--transition-base);
    }

    .list-group-item-action:hover {
        background: rgba(0, 212, 255, 0.15);
        color: var(--color-bright-cyan);
        border-color: rgba(0, 212, 255, 0.3);
        transform: translateX(4px);
    }

    .list-group-item.active {
        background: var(--gradient-primary);
        border-color: var(--color-electric-blue);
        color: white;
    }

    /* Alert Boxes */
    .alert {
        border-radius: var(--radius-lg);
        border: none;
        padding: 1rem 1.25rem;
    }

    .alert-warning {
        background: rgba(255, 176, 32, 0.15);
        color: var(--color-warning);
        border: 1px solid rgba(255, 176, 32, 0.3);
    }

    .alert-warning h5 {
        color: var(--color-warning);
    }

    /* Form Controls */
    .form-control, textarea {
        background: rgba(10, 14, 39, 0.95);
        border: 2px solid var(--glass-border);
        border-radius: var(--radius-lg);
        color: var(--color-text-primary);
        transition: all var(--transition-base);
        font-family: var(--font-code);
    }

    .form-control:focus, textarea:focus {
        background: rgba(10, 14, 39, 0.98);
        border-color: var(--color-electric-blue);
        box-shadow: 0 0 0 3px rgba(0, 102, 255, 0.1), 0 0 20px rgba(0, 212, 255, 0.3);
        color: var(--color-text-primary);
    }

    .form-control::placeholder {
        color: var(--color-text-muted);
    }

    .form-check-input {
        background-color: rgba(45, 59, 84, 0.4);
        border: 2px solid var(--glass-border);
    }

    .form-check-input:checked {
        background-color: var(--color-electric-blue);
        border-color: var(--color-electric-blue);
    }

    .form-check-input:focus {
        box-shadow: 0 0 0 3px rgba(0, 102, 255, 0.2);
    }

    .form-check-label {
        color: var(--color-text-secondary);
    }

    .form-label {
        color: var(--color-text-secondary);
        font-weight: 600;
        font-size: 0.9rem;
    }

    /* Code Editor */
    #model-editor {
        background: rgba(10, 14, 39, 0.95);
        color: var(--color-text-primary);
        border: none;
        font-family: var(--font-code);
        font-size: 14px;
    }

    /* Code Blocks */
    pre {
        background: rgba(10, 14, 39, 0.95);
        border: 1px solid var(--glass-border);
        border-left: 3px solid var(--color-electric-blue);
        border-radius: var(--radius-lg);
        padding: 1rem;
        color: var(--color-text-primary);
    }

    pre code {
        color: var(--color-text-primary);
        font-family: var(--font-code);
    }

    /* Status Colors */
    .text-success {
        color: var(--color-success) !important;
    }

    .text-danger {
        color: var(--color-danger) !important;
    }

    .text-primary {
        color: var(--color-electric-blue) !important;
    }

    .bg-dark {
        background: rgba(10, 14, 39, 0.9) !important;
    }

    .bg-light {
        background: rgba(45, 59, 84, 0.3) !important;
    }

    .text-light {
        color: var(--color-text-primary) !important;
    }

    .text-white {
        color: white !important;
    }

    /* Border */
    .border-dark {
        border-color: var(--glass-border) !important;
    }
</style>
{% endblock %}

{% block content %}
<div class="row">
    <div class="col-12">
        <nav aria-label="breadcrumb">
            <ol class="breadcrumb">
                <li class="breadcrumb-item"><a href="{% url 'dashboard' %}">Dashboard</a></li>
                <li class="breadcrumb-item"><a href="{% url 'lesson_detail' lesson.id %}">{{ lesson.title }}</a></li>
                <li class="breadcrumb-item active">Model Builder</li>
            </ol>
        </nav>
    </div>
</div>

<div class="row mb-4">
    <div class="col-12">
        <div class="card">
            <div class="card-body">
                <h2 class="mb-3">
                    <i class="bi bi-code-square"></i> Model Builder
                </h2>
                <p class="text-muted">Edit, test, and execute your dbt models</p>
            </div>
        </div>
    </div>
</div>

{% if not is_initialized %}
<!-- Initialization Required -->
<div class="row">
    <div class="col-12">
        <div class="alert alert-warning">
            <h5><i class="bi bi-exclamation-triangle"></i> Workspace Not Initialized</h5>
            <p>Your dbt workspace needs to be initialized before you can start building models.</p>
            <form method="post">
                {% csrf_token %}
                <input type="hidden" name="action" value="initialize">
                <button type="submit" class="btn btn-warning">
                    <i class="bi bi-gear"></i> Initialize Workspace
                </button>
            </form>
        </div>
    </div>
</div>
{% else %}
<!-- Workspace Initialized - Show Builder -->
<div class="row g-4">
    <!-- Left Column: Model List and Controls -->
    <div class="col-md-4">
        <!-- Seed Data Section -->
        <div class="card mb-3">
            <div class="card-header bg-primary text-white">
                <h6 class="mb-0"><i class="bi bi-database"></i> Load Seed Data</h6>
            </div>
            <div class="card-body">
                <p class="small text-muted">Load CSV seed data into your schema</p>
                <form method="post" id="seeds-form">
                    {% csrf_token %}
                    <input type="hidden" name="action" value="run_seeds">
                    <button type="submit" class="btn btn-sm btn-outline-primary w-100" id="run-seeds-btn">
                        <i class="bi bi-arrow-down-circle"></i> Run Seeds
                    </button>
                </form>
            </div>
        </div>

        <!-- Model Files List -->
        <div class="card">
            <div class="card-header bg-dark text-white">
                <h6 class="mb-0"><i class="bi bi-file-earmark-code"></i> Model Files</h6>
            </div>
            <div class="list-group list-group-flush">
                {% for model in model_files %}
                <button type="button"
                        class="list-group-item list-group-item-action model-file-btn"
                        data-model-name="{{ model }}"
                        onclick="loadModel('{{ model }}')">
                    <i class="bi bi-file-code"></i> {{ model }}.sql
                </button>
                {% empty %}
                <div class="list-group-item text-muted">
                    <i class="bi bi-info-circle"></i> No models found
                </div>
                {% endfor %}
            </div>
        </div>

        <!-- Execute Models Section -->
        <div class="card mt-3">
            <div class="card-header bg-success text-white">
                <h6 class="mb-0"><i class="bi bi-play-circle"></i> Execute Models</h6>
            </div>
            <div class="card-body">
                <form method="post" id="execute-form">
                    {% csrf_token %}
                    <input type="hidden" name="action" value="execute_models">

                    <div class="mb-3">
                        <label class="form-label small">Select Models:</label>
                        {% for model in model_files %}
                        <div class="form-check">
                            <input class="form-check-input" type="checkbox"
                                   name="selected_models" value="{{ model }}"
                                   id="model_{{ forloop.counter }}">
                            <label class="form-check-label small" for="model_{{ forloop.counter }}">
                                {{ model }}
                            </label>
                        </div>
                        {% endfor %}
                    </div>

                    <div class="mb-3">
                        <div class="form-check">
                            <input class="form-check-input" type="checkbox"
                                   name="include_children" id="include_children">
                            <label class="form-check-label small" for="include_children">
                                Include child models (+)
                            </label>
                        </div>
                        <div class="form-check">
                            <input class="form-check-input" type="checkbox"
                                   name="full_refresh" id="full_refresh">
                            <label class="form-check-label small" for="full_refresh">
                                Full refresh
                            </label>
                        </div>
                    </div>

                    <button type="submit" class="btn btn-success w-100" id="execute-btn">
                        <i class="bi bi-lightning-fill"></i> Execute Selected
                    </button>
                </form>
            </div>
        </div>
    </div>

    <!-- Right Column: Code Editor -->
    <div class="col-md-8">
        <div class="card">
            <div class="card-header bg-dark text-white d-flex justify-content-between align-items-center">
                <h6 class="mb-0" id="editor-title">
                    <i class="bi bi-pencil-square"></i> Select a model to edit
                </h6>
                <button id="save-model-btn" class="btn btn-sm btn-light" style="display: none;">
                    <i class="bi bi-save"></i> Save
                </button>
            </div>
            <div class="card-body p-0">
                <form method="post" id="save-model-form">
                    {% csrf_token %}
                    <input type="hidden" name="action" value="save_model">
                    <input type="hidden" name="model_name" id="current-model-name">
                    <textarea name="model_sql" id="model-editor"
                              class="form-control font-monospace"
                              rows="20"
                              style="border: none; resize: vertical; font-size: 14px;"
                              placeholder="-- Select a model file from the left to start editing"></textarea>
                </form>
            </div>
            <div class="card-footer text-muted small">
                <i class="bi bi-info-circle"></i> Edit your SQL and click Save before executing
            </div>
        </div>

        <!-- Tips Card -->
        <div class="card mt-3">
            <div class="card-header">
                <h6 class="mb-0"><i class="bi bi-lightbulb"></i> Tips</h6>
            </div>
            <div class="card-body">
                <ul class="small mb-0" style="color: var(--color-text-secondary);">
                    <li>Select a model file from the list to edit its SQL</li>
                    <li>Save your changes before executing models</li>
                    <li>Load seed data first if your models depend on raw tables</li>
                    <li>Check the messages above for execution results</li>
                </ul>
            </div>
        </div>
    </div>
</div>

<!-- Real-time dbt Execution Logs -->
<div class="row mt-4" id="streaming-logs-container" style="display: none;">
    <div class="col-12">
        <div class="card border-info">
            <div class="card-header bg-info text-white d-flex justify-content-between align-items-center">
                <h5 class="mb-0">
                    <i class="bi bi-terminal"></i> <span id="streaming-title">dbt Running...</span>
                </h5>
                <div class="spinner-border spinner-border-sm text-white" role="status" id="streaming-spinner">
                    <span class="visually-hidden">Loading...</span>
                </div>
            </div>
            <div class="card-body bg-dark p-0">
                <pre id="streaming-logs" class="text-light p-3 m-0" style="max-height: 500px; overflow-y: auto; font-size: 0.85rem; min-height: 200px; white-space: pre-wrap; word-wrap: break-word;"><code></code></pre>
            </div>
            <div class="card-footer" id="streaming-footer" style="display: none;">
                <div class="alert mb-0" id="streaming-result" role="alert"></div>
            </div>
        </div>
    </div>
</div>

<!-- dbt Execution Logs Display -->
{% if execution_logs or seed_logs %}
<div class="row mt-4">
    <div class="col-12">
        <div class="card border-dark">
            <div class="card-header bg-dark text-white">
                <h5 class="mb-0">
                    <i class="bi bi-terminal"></i> dbt Execution Logs
                </h5>
            </div>
            <div class="card-body bg-light">
                <!-- Seed Logs -->
                {% if seed_logs %}
                <div class="mb-4">
                    <h6 class="text-primary">
                        <i class="bi bi-database"></i> Seed Execution Output
                    </h6>
                    <pre class="bg-dark text-light p-3 rounded" style="max-height: 400px; overflow-y: auto; font-size: 0.85rem; white-space: pre-wrap; word-wrap: break-word;"><code>{{ seed_logs }}</code></pre>
                </div>
                {% endif %}

                <!-- Model Execution Logs -->
                {% if execution_logs %}
                {% for log in execution_logs %}
                <div class="mb-4">
                    <h6 class="{% if log.success %}text-success{% else %}text-danger{% endif %}">
                        <i class="bi bi-{% if log.success %}check-circle-fill{% else %}x-circle-fill{% endif %}"></i>
                        Model: {{ log.model }}
                    </h6>
                    <pre class="bg-dark text-light p-3 rounded" style="max-height: 400px; overflow-y: auto; font-size: 0.85rem; white-space: pre-wrap; word-wrap: break-word;"><code>{{ log.output }}</code></pre>
                </div>
                {% endfor %}
                {% endif %}
            </div>
        </div>
    </div>
</div>
{% endif %}

{% endif %}
{% endblock %}

{% block extra_js %}
<script>
// Load model content when file is clicked
function loadModel(modelName) {
    const editor = document.getElementById('model-editor');
    const editorTitle = document.getElementById('editor-title');
    const saveBtn = document.getElementById('save-model-btn');
    const currentModelName = document.getElementById('current-model-name');

    // Update UI
    editorTitle.innerHTML = `<i class="bi bi-pencil-square"></i> Editing: ${modelName}.sql`;
    currentModelName.value = modelName;
    saveBtn.style.display = 'block';

    // Load model content via AJAX
    fetch('{% url "api_get_model_content" %}', {
        method: 'POST',
        headers: {
            'Content-Type': 'application/x-www-form-urlencoded',
            'X-CSRFToken': '{{ csrf_token }}'
        },
        body: `model_name=${modelName}&lesson_id={{ lesson.id }}`
    })
    .then(response => response.json())
    .then(data => {
        if (data.success) {
            editor.value = data.sql;
            editor.focus();
        } else {
            alert('Error loading model: ' + data.message);
        }
    })
    .catch(error => {
        console.error('Error:', error);
        alert('Failed to load model');
    });

    // Highlight active model in list
    document.querySelectorAll('.model-file-btn').forEach(btn => {
        btn.classList.remove('active');
    });
    event.currentTarget.classList.add('active');
}

// Save model when button clicked
document.getElementById('save-model-btn')?.addEventListener('click', function() {
    document.getElementById('save-model-form').submit();
});

// Streaming logs functionality
let currentEventSource = null;
let streamingTimeoutId = null;

function showStreamingLogs(title) {
    const container = document.getElementById('streaming-logs-container');
    const logsElement = document.getElementById('streaming-logs');
    const titleElement = document.getElementById('streaming-title');
    const spinner = document.getElementById('streaming-spinner');
    const footer = document.getElementById('streaming-footer');

    container.style.display = 'block';
    titleElement.textContent = title;
    logsElement.innerHTML = '';
    spinner.style.display = 'inline-block';
    footer.style.display = 'none';

    // Scroll to logs
    container.scrollIntoView({ behavior: 'smooth', block: 'start' });
}

function appendLog(message) {
    const logsElement = document.getElementById('streaming-logs');
    logsElement.textContent += message + '\n';
    // Auto-scroll to bottom
    logsElement.scrollTop = logsElement.scrollHeight;
}

function finishStreamingLogs(success, message) {
    // Clear any existing timeout
    if (streamingTimeoutId) {
        clearTimeout(streamingTimeoutId);
        streamingTimeoutId = null;
    }

    try {
        const spinner = document.getElementById('streaming-spinner');
        const footer = document.getElementById('streaming-footer');
        const resultElement = document.getElementById('streaming-result');

        if (spinner) spinner.style.display = 'none';
        if (footer) footer.style.display = 'block';

        if (resultElement) {
            if (success) {
                resultElement.className = 'alert alert-success mb-0';
                resultElement.innerHTML = '<i class="bi bi-check-circle-fill"></i> ' + message;
            } else {
                resultElement.className = 'alert alert-danger mb-0';
                resultElement.innerHTML = '<i class="bi bi-x-circle-fill"></i> ' + message;
            }
        }
    } catch (error) {
        console.error('Error updating UI:', error);
    } finally {
        // ALWAYS re-enable buttons, even if there was an error above
        try {
            const executeBtn = document.getElementById('execute-btn');
            const seedsBtn = document.getElementById('run-seeds-btn');

            if (executeBtn) executeBtn.disabled = false;
            if (seedsBtn) seedsBtn.disabled = false;
        } catch (error) {
            console.error('Error re-enabling buttons:', error);
        }
    }
}

function streamLogs(jobId, jobType) {
    // Close any existing event source
    if (currentEventSource) {
        currentEventSource.close();
        currentEventSource = null;
    }

    // Clear any existing timeout
    if (streamingTimeoutId) {
        clearTimeout(streamingTimeoutId);
    }

    // Set a safety timeout (10 minutes) to force re-enable buttons if streaming hangs
    streamingTimeoutId = setTimeout(function() {
        console.warn('Streaming timeout reached - forcing cleanup');
        if (currentEventSource) {
            currentEventSource.close();
            currentEventSource = null;
        }
        finishStreamingLogs(false, 'Operation timed out. Please try again or check the logs.');
    }, 10 * 60 * 1000); // 10 minutes

    const url = `/api/stream-logs/${jobId}/`;
    currentEventSource = new EventSource(url);

    currentEventSource.onmessage = function(event) {
        const data = event.data;

        if (data === '__COMPLETE__') {
            finishStreamingLogs(true, `${jobType} completed successfully!`);
            if (currentEventSource) {
                currentEventSource.close();
                currentEventSource = null;
            }
            // Reload page after a delay to show updated state
            setTimeout(() => location.reload(), 2000);
        } else if (data.startsWith('__ERROR__')) {
            const errorMsg = data.substring(9);
            finishStreamingLogs(false, `${jobType} failed: ${errorMsg}`);
            if (currentEventSource) {
                currentEventSource.close();
                currentEventSource = null;
            }
        } else if (data === '__NOTFOUND__') {
            finishStreamingLogs(false, 'Job not found');
            if (currentEventSource) {
                currentEventSource.close();
                currentEventSource = null;
            }
        } else {
            appendLog(data);
        }
    };

    currentEventSource.onerror = function(error) {
        console.error('EventSource error:', error);
        finishStreamingLogs(false, 'Connection error occurred');
        if (currentEventSource) {
            currentEventSource.close();
            currentEventSource = null;
        }
    };
}

// Handle execute models form with streaming
document.getElementById('execute-form')?.addEventListener('submit', function(e) {
    e.preventDefault();

    const checkedBoxes = document.querySelectorAll('input[name="selected_models"]:checked');
    if (checkedBoxes.length === 0) {
        alert('Please select at least one model to execute');
        return false;
    }

    const modelNames = Array.from(checkedBoxes).map(cb => cb.value).join(', ');
    if (!confirm(`Execute the following models: ${modelNames}?`)) {
        return false;
    }

    // Disable button to prevent double-submission
    try {
        const executeBtn = document.getElementById('execute-btn');
        if (executeBtn) executeBtn.disabled = true;
    } catch (error) {
        console.error('Error disabling execute button:', error);
    }

    // Show streaming logs
    showStreamingLogs(`Executing models: ${modelNames}`);

    // Prepare form data
    const formData = new FormData(this);
    formData.append('stream', 'true');

    // Submit via AJAX
    fetch(window.location.href, {
        method: 'POST',
        body: formData
    })
    .then(response => response.json())
    .then(data => {
        if (data.success && data.job_id) {
            // Start streaming logs
            streamLogs(data.job_id, 'Model execution');
        } else {
            finishStreamingLogs(false, data.error || 'Failed to start execution');
        }
    })
    .catch(error => {
        console.error('Error:', error);
        finishStreamingLogs(false, 'Failed to start execution: ' + error.message);
    });

    return false;
});

// Handle run seeds form with streaming
document.getElementById('seeds-form')?.addEventListener('submit', function(e) {
    e.preventDefault();

    if (!confirm('Load seed data into your schema?')) {
        return false;
    }

    // Disable button to prevent double-submission
    try {
        const seedsBtn = document.getElementById('run-seeds-btn');
        if (seedsBtn) seedsBtn.disabled = true;
    } catch (error) {
        console.error('Error disabling seeds button:', error);
    }

    // Show streaming logs
    showStreamingLogs('Running dbt seeds...');

    // Prepare form data
    const formData = new FormData(this);
    formData.append('stream', 'true');

    // Submit via AJAX
    fetch(window.location.href, {
        method: 'POST',
        body: formData
    })
    .then(response => response.json())
    .then(data => {
        if (data.success && data.job_id) {
            // Start streaming logs
            streamLogs(data.job_id, 'Seed execution');
        } else {
            finishStreamingLogs(false, data.error || 'Failed to start seed execution');
        }
    })
    .catch(error => {
        console.error('Error:', error);
        finishStreamingLogs(false, 'Failed to start seed execution: ' + error.message);
    });

    return false;
});
</script>
{% endblock %}
